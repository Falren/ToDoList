defaults: &defaults
  working_directory: ~/ToDoList
  parallelism: 2

  docker:
    - image: circleci/ruby:2.7.1-node-browsers
      environment:
        PGHOST: localhost
        PGUSER: falren
        RAILS_ENV: test

    - image: circleci/postgres:12.4
      environment:
        POSTGRES_USER: falren
        POSTGRES_DB: ToDoList_test
        POSTGRES_PASSWORD: trust

version: 2
jobs:
  test:
    <<: *defaults
    steps:
      - checkout

      - save_cache:
          key: v2-repo-{{ .Environment.CIRCLE_SHA1 }}
          paths:
            - ~/ToDoList

      - restore_cache:
          keys:
            - gem-cache-{{ arch }}-{{ .Branch }}-{{ checksum "Gemfile.lock" }}
            - gem-cache-{{ arch }}-{{ .Branch }}
            - gem-cache
      - run: bundle install --path vendor/bundle
      - save_cache:
          key: gem-cache-{{ arch }}-{{ .Branch }}-{{ checksum "Gemfile.lock" }}
          paths:
            - ~/ToDoList/vendor/bundle

      - restore_cache:
          keys:
            - yarn-cache-{{ arch }}-{{ .Branch }}-{{ checksum "yarn.lock" }}
            - yarn-cache-{{ arch }}-{{ .Branch }}
            - yarn-cache
      - run:
          name: Yarn Install
          command: yarn install --cache-folder ~/.cache/yarn
      - save_cache:
          key: yarn-cache-{{ arch }}-{{ .Branch }}-{{ checksum "yarn.lock" }}
          paths:
            - ~/ToDoList/.cache/yarn
      - run: dockerize -wait tcp://localhost:5432 -timeout 1m
      - run: bundle exec rails db:create
      - run: bundle exec rails db:migrate

      - run:
          name: Parallel Rspec
          environment:
            - RAILS_ENV: test
            - RACK_ENV: test
          command: |
            mkdir -p /tmp/rspec
            TEST_FILES="$(circleci tests glob "spec/**/*_spec.rb" | circleci tests falren --falren-by=timings)"
            bundle exec rspec --profile 10 \
                              --format RspecJunitFormatter \
                              --out /tmp/rspec/rspec.xml \
                              --format progress \
                              -- \
                              $TEST_FILES
      - store_test_results:
          path: /tmp/rspec

      - run:
          name: Stash Coverage Results
          command: |
            mkdir coverage_results
            cp -R coverage/.resultset.json coverage_results/.resultset-${CIRCLE_NODE_INDEX}.json
      - persist_to_workspace:
          root: .
          paths:
            - coverage_results

  coverage:
    <<: *defaults
    steps:
      - attach_workspace:
          at: .

      - restore_cache:
          key: v2-repo-{{ .Environment.CIRCLE_SHA1 }}

      - restore_cache:
          keys:
            - gem-cache-{{ arch }}-{{ .Branch }}-{{ checksum "Gemfile.lock" }}
            - gem-cache-{{ arch }}-{{ .Branch }}
            - gem-cache

      - run: bundle install --path vendor/bundle

      - run:
          name: Merge and check coverage
          command: |
            RUN_COVERAGE=true bundle exec rake simplecov:report_coverage
      - store_artifacts:
          path: ~/ToDoList/coverage
          destination: coverage

workflows:
  version: 2
  build_and_test:
    jobs:
        - test
        - coverage:
            requires:
              - test